name: Cloudflare KV Auto-Updater (Ultimate)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"  # Runs automatically every hour

concurrency:
  group: kv-auto-update
  cancel-in-progress: true

env:
  CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
  CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
  CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
  CF_VAR_KEY: BESTIP
  BESTIP: ${{ secrets.BESTIP }}
  CF_WORKER_NAME: ${{ secrets.CF_WORKER_NAME }}
  CF_KV_BINDING_NAME: KV

jobs:
  update-kv:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: ðŸ§° Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸŒ Update Cloudflare KV Automatically
        shell: bash
        run: |
          set -euo pipefail

          echo "=== Cloudflare KV update started ==="
          echo "=> Start time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "=> Configuration:"
          echo "   â€¢ Account ID: ${CF_ACCOUNT_ID}"
          echo "   â€¢ Namespace ID: ${CF_KV_NAMESPACE_ID}"
          echo "   â€¢ KV Key: ${CF_VAR_KEY}"
          echo "   â€¢ Worker: ${CF_WORKER_NAME:-<none>}"
          echo "   â€¢ Best IP: ${BESTIP}"
          echo ""

          # --- Validate Required Variables ---
          for var in CF_ACCOUNT_ID CF_API_TOKEN CF_KV_NAMESPACE_ID CF_VAR_KEY BESTIP; do
            if [ -z "${!var:-}" ]; then
              echo "âŒ ERROR: $var is not set"
              exit 1
            fi
          done
          echo "âœ… All required environment variables are set."

          # --- REST API Retry Function ---
          retry_kv_put() {
            local attempt=1
            local max_attempts=5
            local base_sleep=2

            while [ "$attempt" -le "$max_attempts" ]; do
              echo ""
              echo "â†’ Attempt #${attempt}/${max_attempts} to update KV via REST API"
              local api_url="https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/storage/kv/namespaces/${CF_KV_NAMESPACE_ID}/values/${CF_VAR_KEY}"

              local tmp_resp
              tmp_resp=$(mktemp)
              local code
              code=$(curl -s -w "%{http_code}" -X PUT "$api_url" \
                -H "Authorization: Bearer ${CF_API_TOKEN}" \
                -H "Content-Type: text/plain" \
                --data-raw "${BESTIP}" \
                --max-time 15 --connect-timeout 10 \
                -o "$tmp_resp" 2>/dev/null || echo "000")

              local body
              body=$(cat "$tmp_resp" 2>/dev/null || echo "")
              rm -f "$tmp_resp"

              echo "   â€¢ HTTP Status: ${code}"

              if [ "$code" = "200" ] || [ "$code" = "204" ]; then
                echo "âœ… KV successfully updated via REST: ${BESTIP}"
                return 0
              fi

              echo "âš ï¸ KV PUT failed (HTTP ${code})"
              case "$code" in
                000) echo "   â€¢ Network issue or timeout";;
                401) echo "âŒ Unauthorized"; return 2;;
                403) echo "âŒ Forbidden"; return 3;;
                404) echo "âŒ Namespace not found"; return 4;;
                405) echo "âŒ Method not allowed (bound namespace)"; return 5;;
                429|500|502|503|504)
                  echo "   â€¢ Temporary error, will retry..."
                  ;;
                *) echo "   â€¢ Unexpected HTTP ${code}";;
              esac

              if [ "$attempt" -lt "$max_attempts" ]; then
                sleep_time=$((base_sleep * attempt))
                echo "   â€¢ Waiting ${sleep_time}s before retry..."
                sleep "$sleep_time"
              fi
              attempt=$((attempt + 1))
            done
            echo "âŒ All REST attempts failed."
            return 1
          }

          # --- Execute REST with Safe Exit ---
          set +e
          retry_kv_put
          rv=$?
          set -e

          if [ "$rv" -eq 0 ]; then
            echo "âœ… KV successfully updated via REST API"
          else
            echo ""
            echo "âš™ï¸ Switching to Wrangler fallback (error code $rv)"

            # Install Node.js if missing
            if ! command -v node >/dev/null 2>&1; then
              sudo apt-get update -y && sudo apt-get install -y nodejs npm
            fi

            echo "=> Installing Wrangler..."
            npm install -g wrangler@3 --no-progress || echo "âš ï¸ npm install failed, using npx fallback"

            if command -v wrangler >/dev/null 2>&1; then
              WRANGLER_CMD="wrangler"
            else
              WRANGLER_CMD="npx wrangler"
            fi

            export CLOUDFLARE_API_TOKEN="${CF_API_TOKEN}"
            BIND_NAME="${CF_KV_BINDING_NAME:-KV}"

            echo "â†’ Running Wrangler KV put..."
            set +e
            ${WRANGLER_CMD} kv:key put --binding="${BIND_NAME}" "${CF_VAR_KEY}" "${BESTIP}" --account-id="${CF_ACCOUNT_ID}" 2>&1 | tee /tmp/wrangler.log
            WRANGLER_EXIT=$?
            set -e

            if [ "$WRANGLER_EXIT" -eq 0 ]; then
              echo "âœ… KV successfully updated via Wrangler fallback"
            else
              echo "âŒ FATAL: Wrangler fallback failed"
              tail -n 50 /tmp/wrangler.log || true
              exit 1
            fi
          fi

          # --- Optional Worker Health Check ---
          if [ -n "${CF_WORKER_NAME:-}" ]; then
            echo ""
            echo "ðŸ©º Performing Worker Health Check..."
            HEALTH_URL="https://${CF_WORKER_NAME}.workers.dev/health"

            ok=false
            for i in {1..3}; do
              echo "â†’ Checking attempt $i/3"
              code=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$HEALTH_URL" 2>/dev/null || echo "000")
              echo "   â€¢ Status: ${code}"
              if [ "$code" = "200" ]; then
                echo "âœ… Worker is healthy."
                ok=true
                break
              elif [ "$code" = "404" ]; then
                echo "â„¹ï¸ Health endpoint not implemented (normal)"
                ok=true
                break
              else
                echo "âš ï¸ Worker not responding, retrying..."
                sleep 3
              fi
            done
            if [ "$ok" = false ]; then
              echo "âš ï¸ WARNING: Worker Health Check failed."
            fi
          else
            echo "â„¹ï¸ CF_WORKER_NAME not set, skipping health check."
          fi

          echo ""
          echo "bestip=${BESTIP}" >> "$GITHUB_OUTPUT"
          echo "âœ… Cloudflare KV Update Completed Successfully"
          echo "=> Final IP: ${BESTIP}"
          echo "=> End time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "=== Cloudflare KV update ended ==="
